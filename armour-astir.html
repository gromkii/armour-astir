<!-- 
  Design considerations
  - move catchphrase into Character Info, only appear if channeler.\
  - move traits + dangers up, and add ideals underneath it?
 -->

<div class="main">
  <div class="top-section">
    <div class="page-header">
      <div class="header">
        <input type="text" placeholder="Character Name" name="attr_character_name" />
      </div>
      <div class="header">
        <input type="text" class="playbook" name="attr_playbook" placeholder="Playbook"/>
        <!-- TODO: Make this an attr_ and create sheet script. -->
      </div>
    </div>

    <div class="navigation">
      <button type="action" name="act_character">Character</button>
      <button type="action" name="act_astir">Astir</button>
      <button type="action" name="act_misc">Misc</button>
    </div>

    <input type="hidden" class="tabstoggle" name="attr_sheet_tab" value="character"/>

    <div class="character-page">
      <div class="character-upper-section">
        <div class="character-descriptors section">
          <h3>
            Character Info
          </h3>
          <div class="section-content">
          <input type="hidden" name="attr_playbook_descriptors" class="descriptors-toggle"/>
            <div class="descriptor">
              <input type="text" name="attr_character_pronouns"/>
              <label>Pronouns...</label>
            </div>
            <div class="descriptor">
              <input type="text" name="attr_character_looks"/>
              <label>You look...</label>
            </div>
            <div class="descriptor">
              <input type="text" name="attr_character_wears"/>
              <label>You wear...</label>
            </div>
            
            <!-- attr_playbook 0-3 -->
            <div class="descriptor channeler">
              <input type="text" name="attr_character_magic"/>
              <label>Your magic is like...</label>
            </div>

            <div class="descriptor channeler">
              <textarea rows="2" name="attr_character_catchphrase"></textarea>
              <label>When You Launch Your Astir, You Say...</label>
            </div>
            
            <!-- attr_playbook 4 -->
            <div class="descriptor scout">
              <input type="text" name="attr_character_fights"/>
              <label>You fight with...</label>
            </div>
            
            <!-- attr_playbook 5 -->
            <div class="descriptor captain">
              <input type="text" name="attr_character_leads"/>
              <label>You lead with...</label>
            </div>
            
            <!-- attr_playbook 6-7 -->
            <div class="descriptor support">
              <input type="text" name="attr_character_handiworks"/>
              <label>Your handiwork looks...</label>
            </div>
            
          </div>
        </div>
        <div class="character-info">
          <div class="character-traits section">
            <h3> 
              Traits            
            </h3>
            <div class="section-content">
              <div class="traits">
                <div class="trait">
                  <div class="trait-top">
                    <input type="number" value="1" name="attr_defy">
                  </div>
                  <div class="trait-bottom">  
                    <button 
                      name="roll_defy" 
                      type="roll" 
                      value="&{template:default} {{name=DEFY}} {{result=[[2d6 + @{defy}]]}}">
                      <span>DEFY</span>
                    </button>
                  </div>
                </div>
                 
                <div class="trait">
                  <div class="trait-top">
                    <input type="number" value="1" name="attr_sense">
                  </div>
                  <div class="trait-bottom">  
                    <button 
                      name="roll_sense" 
                      type="roll" 
                      value="&{template:default} {{name=SENSE}} {{result=[[2d6 + @{sense}]]}}">
                      <span>SENSE</span>
                    </button>
                  </div>
                </div>
                 
                <div class="trait">
                  <div class="trait-top">
                    <input type="number" value="1" name="attr_clash">
                  </div>
                  <div class="trait-bottom">  
                    <button 
                      name="roll_clash" 
                      type="roll" 
                      value="&{template:default} {{name=CLASH}} {{result=[[2d6 + @{clash}]]}}">
                      <span>CLASH</span>
                    </button>
                  </div>
                </div>
                 
                <div class="trait">
                  <div class="trait-top">
                    <input type="number" value="1" name="attr_talk">
                  </div>
                  <div class="trait-bottom">  
                    <button 
                      name="roll_talk" 
                      type="roll" 
                      value="&{template:default} {{name=TALK}} {{result=[[2d6 + @{talk}]]}}">
                      <span>TALK</span>
                    </button>
                  </div>
                </div>
                 
                <div class="trait">
                  <div class="trait-top">
                    <input type="number" value="1" name="attr_know">
                  </div>
                  <div class="trait-bottom">  
                    <button 
                      name="roll_know" 
                      type="roll" 
                      value="&{template:default} {{name=KNOW}} {{result=[[2d6 + @{know}]]}}">
                      <span>KNOW</span>
                    </button>
                  </div>
                </div>

                <!-- Hidden based on playbook. -->
                <input type="hidden" class="channel_hidden" name="attr_channel_hidden" value="false" />
                <div class="trait trait-channel">
                  <div class="trait-top">
                    <input type="number" value="1" name="attr_channel">
                  </div>
                  <div class="trait-bottom">  
                    <button 
                      name="roll_channel" 
                      type="roll" 
                      value="&{template:default} {{name=CHANNEL}} {{result=[[2d6 + @{channel}]]}}">
                      <span>CHANNEL</span>
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </div>
          
          <div class="character-dangers section">
            <h3>
              Dangers
            </h3>
            <div class="section-content">
              <div class="danger">
                <div class="character-danger-type">
                  <div class="danger-group">
                    <input type="checkbox" /><span class="danger-type">Risk</span>
                  </div>
                  <div class="danger-group">
                    <input type="checkbox" /><span class="danger-type">Peril</span>
                  </div>
                </div>
                <div class="character-danger-input">
                  <input type="text" class="input-full" />
                </div>
              </div>
              <div class="danger">
                <div class="character-danger-type">
                  <div class="danger-group">
                    <input type="checkbox" /><span class="danger-type">Risk</span>
                  </div>
                  <div class="danger-group">
                    <input type="checkbox" /><span class="danger-type">Peril</span>
                  </div>
                </div>
                <div class="character-danger-input">
                  <input type="text" class="input-full" />
                </div>
              </div>
              <div class="danger">
                <div class="character-danger-type">
                  <div class="danger-group">
                    <input type="checkbox" /><span class="danger-type">Risk</span>
                  </div>
                  <div class="danger-group">
                    <input type="checkbox" /><span class="danger-type">Peril</span>
                  </div>
                </div>
                <div class="character-danger-input">
                  <input type="text" class="input-full" />
                </div>
              </div>
            </div>
          </div>

          <div class="character-ideals section">
            <!-- Repeating input section. -->
            <h3>Ideals</h3>
            <div class="section-content">
              <fieldset class="repeating_ideals">
                <input type="text" name="attr_ideal" />
              </fieldset>
            </div>
          </div>
        </div>
      </div>

      <div class="character-lower-section">
        <div class="character-moves section">
          <h3>Moves</h3>
          <div class="section-content">
            <div class="character-moves-container">

              <div class="move-list-container">
                <h4>Basic Moves</h4>
                <fieldset class="repeating_basicmoves">
                  <div class="move-main">

                    <input type="hidden" name="attr_domove" />
                    <input type="hidden" name="attr_move_rollvalue" value="" />
                    <button type="roll" name="roll_move_rollvalue" value="@{move_rollvalue}">Roll</button>

                    <span name="attr_move_name" value="@{move_name}"></span>
                    <input type="checkbox" name="attr_move_selected" class="move-selected" />
                    <input type="checkbox" name="attr_move_expanded" class="move-expandtoggle" />
    
                    <div class="move-expansion">
                      <input type="text" name="attr_move_name_base" />
                      <label>Move Name</label>
                      
                      <input type="text" name="attr_move_trait" />
                      <label>Trait (Comma Separate Multiple)</label>
                      
                      <input type="text" name="attr_move_success" />
                      <label>Success (10+)</label>
    
                      <input type="text" name="attr_move_partial" />
                      <label>Partial (7-9)</label>
    
                      <input type="text" name="attr_move_miss">
                      <label>Miss (6 or less)</label>
    
                      <textarea type="text" name="attr_move_details"></textarea>
                      <label>Details</label> 
    
                    </div>
                  </div>
                </fieldset>
              </div>

              <div class="move-list-container">
                <h4>Playbook Moves</h4>
                <fieldset class="repeating_moves">
                  <div class="move-main">
                    <input type="checkbox" name="attr_move_expanded" class="move-expandtoggle" />
                    <div class="move-display">
                      <input type="checkbox" name="attr_move_selected" class="move-selected" />
                      <span name="attr_move_name" value="@{move_name}"></span>
                    </div>
    
                    <div class="move-expansion">
                      <input type="text" name="attr_move_name_base" />
                      <label>Move Name</label>
                      
                      <input type="text" name="attr_move_trait" />
                      <label>Trait (Comma Separate Multiple)</label>
                      
                      <input type="text" name="attr_move_success" />
                      <label>Success (10+)</label>
    
                      <input type="text" name="attr_move_partial" />
                      <label>Partial (7-9)</label>
    
                      <input type="text" name="attr_move_miss">
                      <label>Miss (6 or less)</label>
    
                      <textarea name="attr_move_details"></textarea>
                      <label>Details</label> 
    
                    </div>
                  </div>
                </fieldset>
              </div>
            </div>
          </div>
        </div>
        
        <div class="character-lower-info">
          
          <div class="character-gear section">
            <h3>Gear</h3>
            <div class="section-content">
              <fieldset class="repeating_gearlist">
                <!-- 
                  {Quantity} {Name} - {Tier} ({tags} / {tags})
                 -->
                 <span name="attr_quantity" value="@{quantity}"></span>
                 <span name="attr_name" value="@{name}"></span>
                 <span name="attr_tier" value="@{tier}"></span>
                 <span name="attr_tags" value="@{tags}" class="italics"></span>
              </fieldset>

              <fieldset class="repeating_gearcheck">
                <div class="gear-main">
                  <input type="checkbox" name="attr_gear_expanded" class="gear-expandtoggle" />
                  <div class="gear-display">
                    <input type="checkbox" name="attr_gear_equip" class="gear-equip" />
                    <span name="attr_gear_name" value="@{gear_name}"></span>
                    <span name="attr_gear_tier" value="@{gear_tier}"></span>
                    <span name="attr_gear_tags" value="@{gear_tags}"></span>
                  </div>
                  <!-- <input type="checkbox" class="expander expand-gear"> -->
                  <div class="gear-expansion">
                    <!-- name -->
                    <input type="text" class="gear-edit" name="attr_gear_name_edit" value="" />
                    <label>Name</labeL>
                    <!-- tier -->
                    <input type="text" class="gear-edit" name="attr_gear_tier_edit" value="" />
                    <label>Tier</label>
                    <!-- tags -->
                    <input type="text" class="gear-edit" name="attr_gear_tags_edit" value="" />
                    <label>Tags (Comma Separated)</label>
                  </div>

                </div>
              </fieldset>

            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="astir-page">
      <div class="section-row">
        <div class="section flex-1">
          <h3>Astir Information</h3>
          <div class="section-content">
            <div class="info-row">
              <div class="flex-2">
                <input type="text" name="attr_astir_name"/>
                <label>Astir Name</label>
              </div>
              <div class="flex-1">
                <input type="number" name="attr_astir_tier"/>
                <label>Tier</label>
              </div>
              <div class="flex-1">
                <input type="number" name="attr_astir_mana"/>
                <label>Mana</label>
              </div>
            </div>
            <div class="info-row">
              <div class="flex-1">
                <input type="text" name="attr_astir_approach" />
                <label>Approach</label>
              </div>
              <div class="flex-1">
                <input type="text" name="attr_astir_core" />
                <label>Core</label>
              </div>
              <div class="flex-1">
                <input type="checkbox" name="attr_astir_overheating" />
                <label>Overheating</label>
              </div>
            </div>
            <div class="info-row">
              <textarea name="attr_astir_description"></textarea>
              <label>Description</label>
            </div>
          </div>
        </div>

        <div class="section flex-1">
          <h3>Astir Parts</h3>
          <div class="section-content">
            <input type="text" name="attr_part_a_name">
            <label>Part A</label>

            <textarea name="attr_part_a_description"></textarea>
            <label>Description</label>
            
            <input type="text" name="attr_part_b_name">
            <label>Part B</label>

            <textarea name="attr_part_b_description"></textarea>
            <label>Description</label>
          </div>
        </div>
      </div>

      <div class="section-row">
        <div class="section flex-1">
          <h3>Astir Move</h3>
          <div class="section-content">
            <div>
              <input type="text" name="attr_astir_move_name">
              <label>Name</label>
            </div>
            <div>
              <textarea name="attr_astir_move_description"></textarea>
              <label>Description</label>
            </div>
          </div>
        </div>

        <div class="section flex-2">
          <h3>Weapons</h3>
          <div class="section-content">
            <fieldset class="repeating_astir_weapons">
              <div class="info-row">
                <div class="flex-1">
                  <input type="text" name="attr_weapon_equip" />
                  <label>Equip</label>
                </div>
                
                <div class="flex-1">
                  <input type="text" name="attr_weapon_name" />
                  <label>Name</label>
                </div>
  
                <div class="flex-2">
                  <input type="text" name="attr_weapon_tags" class="italics" />
                  <label>Tags</label>
                </div>
              </div>
            </fieldset>
          </div>
        </div>
      </div>
    </div>

    <div class="misc-page">
      Misc page. :D
    </div>

  </div>

  
</div>


<!-- MOVE TEMPLATE -->
<!-- 
  &{template:move} 
  {{charname=CHARACTER_NAME}}
  {{movename=MOVE_NAME}} 
  {{trait=TRAIT}}
  {{miss=MISS}}
  {{partial=PARTIAL}}
  {{success=SUCCESS}}
  {{details=DETAILS}}
  {{result=RESULT}}
-->
<rolltemplate class="sheet-rolltemplate-move">
  <div class="sheet-template-container">
    <div class="sheet-template-header">{{charname}}</div>
    {{movename}}

    {{#result}}<div class="sheet-template-row">{{trait}}: {{result}}</div>{{/result}}

    {{#rollGreater() result 9}}
    {{#success}}
    <div class="sheet-template-row">Success: {{success}}</div>
    {{/success}}
    {{/rollGreater() result 9}}

    {{#rollBetween() result 7 9}}
    {{#partial}}
    <div class="sheet-template-row">Partial: {{partial}}</div>
    {{/partial}}
    {{/rollBetween() result 7 9}}

    {{#rollLess() result 7}}
    {{#miss}}
    <div class="sheet-template-row">Miss: {{miss}}</div>
    {{/miss}}
    {{/rollLess() result 7}}


    {{#details}}<div class="sheet-template-row">{{details}}</div>{{/details}}
  </div>
</rolltemplate>

<script type="text/worker">

  const bookName = {
    0: 'arcanist',
    1: 'impostor',
    2: 'paradigm',
    3: 'witch',
    4: 'scout',
    5: 'captain',
    6: 'artificer',
    7: 'diplomat'
  };

  const playbookMoves ={ // basic moves
    basic: [
      {
        fullName: 'Weather The Storm',
        rolls: ['DEFY', 'KNOW'],
        success: 'You mange to make it to safety.',
        partial: 'You succeed, but at some cost - your Director will ask you to settle for less, take a *risk*, or make a difficult choice.',
      },
      {
        fullName: 'Read The Room',
        roll: 'SENSE', // ! Single roll, automatically does it, or prompt for bonus?
        success: 'Hold 3',
        partial: 'Hold 1',
        miss: 'On a failure, you may ask one of the below questions, but the answer creates a problem or puts you in danger.',
        details: 'Spend your hold 1-for-1 to ask the following questions. Your hold lasts until you leave the current situation or it changes significantly. \n\n • Who has the upper hand here?\n • What is being overlooked here?\n • How does x really feel?\n • What are x\'s real intentions?\n • How is x at risk or in peril? \n\n Roll with Advantage when you act on the answers to what you\'ve asked',
      },
      {
        fullName: 'Dispel Uncertainties',
        roll: 'KNOW',
        success: 'The Director will tell you something directly useful you know about the situation or subject at hand.',
        partial: 'The Director will tell you something potentially useful, but it is up to you to discern how. The Director might ask you to explain how you know that information, or where you learned it.',
      },
      {
        fullName: 'Help or Hinder',
        roll: 'GRAVITY', // ! This one might be tricky to handle.
        succcess: 'They take Advantage (help) or Disadvantage (hinder) to their roll.',
        partial: 'As above, but you become entangled in the consequences of their actions, and possibly cause them.'
      },
      {
        fullName: 'Weave Magic',
        roll: 'CHANNEL',
        success: 'You manage to channel power the way you desired without ill effect.',
        partial: 'You succeed, but your invocation is twisted in an unexpected and dangerous way.'
      },
      {
        fullName: 'Cool Off',
        rolls: ['DEFY', 'SENSE', 'KNOW', 'CLASH', 'TALK'],
        success: 'You/they erase a *risk* or untick \'overheating\' from an Astir.',
        partial: 'As above, but your moment of safety is interrupted.'
      },
      {
        fullName: 'Exchange Blows',
        rolls: ['CLASH', 'TALK'],
        success: 'Either your opponent takes a *risk*, or you take a *risk* and put your opponent in *peril.*',
        partial: 'Both you and your target are forced to take a *risk*',
      },
      {
        fullName: 'Strike Decisively',
        rolls: ['CLASH', 'TALK'],
        success: 'You strike true. Director characters are killed, forced to retreat, or otherwise removed as a threat as per the fiction. Player characters should <b>bite the dust</b>.',
        partial: 'You succeed as above, but choose 1.',
        details: '• You overreach or underestimate - take a *risk*. \n •You waste ammo or words, losing use of a weapon until you can re-arm, or losing the weight of some bargaining chip or piece of leverage. \n • You strike carelessly, causing colateral damage beyond your expectations.'
      },
      {
        fullName: 'Bite the Dust',
        roll: 'DEFY',
        success: 'They miss, hesitate, or you\'re saved by sheer luck - you rally, and clear a *risk* if you have one.',
        partial: 'Retreat from the Sortie safely, or be put in *peril.*',
        miss: 'On a fail, that strike was sure decisive. Decide with your Director the consequences of what has happened to you - what was damaged? Have hat you lost? Who and what is changed by your defeat?',
        details: 'If you survive, you are changed by your defeat. As well as the above, choose one: \n\n • Increase one of your Traits by 1 and reduce another by 1 (no Trait may be higher lower than +/- 3)\n • Choose a new playbook. Keep what moves you and the Director agree are truly part of your character, and discard the others. Replace them with the starting moves for your new playbook. You do not gain its starting equipment.',
      }
    ],
    arcanist: [
      {
        fullName:'Prepare Rituals',
        details: 'You have a practiced set of **rituals** you use to enhance'
        + 'your piloting talents. Discuss what they are with your GM and where you perform them. When someone'
        + '**leads a sortie**, choose 2 **rituals** you had time to perform:\n\n'
        + '• A **realigning ritual** - Increase one of your Traits by 1 and reduce another by 1 (no Trait may be higher or lower than -/+3)\n\n'
        + '• A **contingency ritual** - Specify three specific situations: if you find yourself in one of them, increase your level of success on your next move and this ritual expires.\n\n'
        + '• An **adaptation ritual** - when you fail a roll, take Advantage on your next one.\n\n'
        + '• A **clarity ritual** - When you **read the room&&, you may ask questions of a broader situation than here and now.\n\n'
        + 'All rituals expire after the Sortie, and you lose their effects when that happens.',
        moveSelected: true,
      }
    ]
  };

const playbookGear = {
  arcanist: {
      startingGear: [
          {
              name: 'Astir',
              tier: 'III',
              quantity: 1
          },
          {
              name: 'Touch Spells',
              tier: 'I',
              tags: ['melee', 'bane'],
          },
          {
              name: 'Arcanist Gear',
              quantity: 2
          },
          {
              name: 'Clothing appropriate for your look.'
          }
      ],
      classGear: [
          {
              name: 'Telescoping Staff',
              tier: 'I',
              tags: [
                  'ranged'
              ],
              checked: false
          },
          {
              name: 'Reagent Knife',
              tier: 'I',
              tags: [
                  'melee',
                  'mundane'
              ]
          },
          {
            name: 'Sidearm',
            tier: 'I',
            tags: [
              'ranged',
              'defensive',
            ],
          },
          {
            name: 'Shield Broach',
            tier: 'I',
            tags: [
              'ward'
            ]
          }
      ]
  },

}

  const buttonlist = ['character', 'astir', 'misc'];
  buttonlist.forEach(button => {
      on(`clicked:${button}`, function() {
          setAttrs({
              sheet_tab: button
          });
      });
  });

  // Show/Hide 'CHANNEL' Trait.
  on(`change:support`, (event) => {
    setAttrs({
      channel_hidden: event.newValue == 'on',
    });
  })

  on(`change:playbook`, (event) => {
    if (event && event.newValue && event.netValue !== event.previousValue) {
      setPlaybook(event.newValue);
    }
  });

  // ---- GEARLIST EDIT ----- //
  // Not sure we'll need this one.

  // ---- GEARCHECK EDIT ----- //
  on('change:repeating_gearcheck:gear_expanded', (value) => {
    getAttrs(['repeating_gearcheck_gear_name', 'repeating_gearcheck_gear_tier', 'repeating_gearcheck_gear_tags'], (v) => {
      const name = v.repeating_gearcheck_gear_name || '';
      const tier= v.repeating_gearcheck_gear_tier || '';
      const tags = v.repeating_gearcheck_gear_tags || undefined;
      const parsedTags = tags ? tags.replace('- (', '').replace(')', '').split(' / ').join(', ') : ''; // This sucks.


      // TODO: Compare values for attrs and only the ones that have changed.
      setAttrs({
        repeating_gearcheck_gear_name_edit: name, 
        repeating_gearcheck_gear_tier_edit: tier,
        repeating_gearcheck_gear_tags_edit: parsedTags,
      });
    });
  });

  on('change:repeating_gearcheck:gear_name_edit', () => {
    getAttrs(['repeating_gearcheck_gear_name_edit'], (values) => {
      setAttrs({ repeating_gearcheck_gear_name: values.repeating_gearcheck_gear_name_edit });
    });
  });

  on('change:repeating_gearcheck:gear_tier_edit', () => {
    getAttrs(['repeating_gearcheck_gear_tier_edit'], (values) => {
      setAttrs({ repeating_gearcheck_gear_tier: values.repeating_gearcheck_gear_tier_edit });
    });
  });

  on('change:repeating_gearcheck:gear_tags_edit', () => {
    getAttrs(['repeating_gearcheck_gear_tags_edit'], (values) => {
      const tags = values.repeating_gearcheck_gear_tags_edit;
      const parsedTags = tags ? `- (${tags.replace(' ', '').split(',').join(' / ')})` : '';
      setAttrs({ repeating_gearcheck_gear_tags: parsedTags });
    });
  });


  // ----- MOVES EDIT ----- //
    on('change:repeating_moves:move_name_base', () => {
      getAttrs(['repeating_moves_move_name_base'], (v) => {
        console.log(v);
        setAttrs({
          repeating_moves_move_name: v.repeating_moves_move_name_base
        });
      });
    });
    
    on('change:repeating_basicmoves:move_name_base', () => {
      getAttrs(['repeating_moves_move_name_base'], (v) => {
        console.log(v);
        setAttrs({
          repeating_basicmovesmoves_move_name: v.repeating_moves_move_name_base
        });
      });
    });

    on('change:repeating_moves:move_name_base', () => {
      getAttrs(['repeating_moves_move_name_base'], (v) => {
        setAttrs({
          repeating_moves_move_name: v.repeating_moves_move_name_base
        }, () => {
          // ! Set roll value.
        })
      })
    })

    on('change:repating_moves:move_trait', () => {
      getAttrs(['repeating_moves_move_trait'], (v) => {
        setAttrs({
          repeating_moves_move_trait: v.repeating_moves_move_trait
        }, () => {
          // ! Set roll value.
        })
      })
    })

    on('change:repating_moves:move_success', () => {
      getAttrs(['repeating_moves_move_success'], (v) => {
        setAttrs({
          repeating_moves_move_success: v.repeating_moves_move_success
        }, () => {
          // ! Set roll value.
        })
      })
    })

    on('change:repating_moves:move_partial', () => {
      getAttrs(['repeating_moves_move_partial'], (v) => {
        setAttrs({
          repeating_moves_move_partial: v.repeating_moves_move_partial
        }, () => {
          // ! Set roll value.
        })
      })
    })

    on('change:repating_moves:move_miss', () => {
      getAttrs(['repeating_moves_move_miss'], (v) => {
        setAttrs({
          repeating_moves_move_miss: v.repeating_moves_move_miss
        }, () => {
          // ! Set roll value.
        })
      })
    })


  // ----- HELPER FUNCTIONS ----- //
  function setPlaybook(book) {
    const bookValue = getPlaybookValue(book);
    const playbook = bookName[bookValue];
    setPlaybookValue(bookValue);
    setMoves(playbook);
    setGear(playbook);
    setBasicMoves(playbook);
    setMoves()
  }

  function getPlaybookValue(book) {
    const value = book.toLowerCase().replace('the ', '');
    switch(value) {
      case 'arcanist' : return 0;
      case 'impostor' : return 1;
      case 'paradigm' : return 2;
      case 'witch'    : return 3;
      case 'scout'    : return 4;
      case 'captain'  : return 5;
      case 'artificer': return 6;
      case 'diplomat' : return 7;
      default         : return 0; // ? Setup error handling case?
    }
  }

  function setPlaybookValue(book) {
    setAttrs({
      playbook_descriptors: `${book}`,
      channel_hidden: book > 3,
    });
  }

  function setBasicMoves() {
    clearBasicMoveList();

    playbookMoves.basic.forEach((move) => {
      addBasicMove(move, true);
    });
  }

  function setMoves(book) {
    if (!playbookMoves[book]) {
      console.log('Error, playbook not found.')
      return;
    }
    
    clearMoveList();

    const moves = playbookMoves[book];
    moves.forEach((move) => {
      addBasicMove(move, false);
    })
  }

  function setGear(book) {
    // Remove current gear.
    if (!bookName[book]) {
      return;
    }
    
    setGear(bookName[book]);

  }

  // Add Moves from SRD (defined in playbook.js, copy/pasted here. Doesn't actually pull them in.)
  function addBasicMove(m, basicMove) {
    const newRowId = generateRowID();
    const moves =  basicMove ? 'basicmoves' : 'moves';
    const prefix = `repeating_${moves}_${newRowId}_move_`;
    const attrs = {};

    attrs[prefix + 'name'] = m.fullName;
    attrs[prefix + 'name_base'] = m.fullName;

    
    // TODO: Create a function to sanitize the text.
    if (m.success) attrs[prefix + 'success'] = m.success.replace(/,/g, '&#44;');
    if (m.partial) attrs[prefix + 'partial'] = m.partial.replace(/,/g, '&#44;');
    if (m.miss) attrs[prefix + 'miss'] = m.miss.replace(/,/g, '&#44;');
    if (m.details) attrs[prefix + 'details'] = m.details.replace(/,/g, '&#44;');

    attrs[prefix + 'doroll'] = (m.roll || m.rolls) ? 1 : 0;
    
    setAttrs(attrs, () => {
      rollAttrs = {};
      if (m.rolls) {
        rollAttrs[prefix + 'rollvalue'] = buildRollValue(m.rolls, prefix);
      } else if (m.roll) {
        const rollTemplate = buildRollTemplateValue(m.roll, prefix);
        rollAttrs[prefix + 'rollvalue'] = buildSingleRollValue(m.roll, prefix);
      }
      
      setAttrs(rollAttrs);
    });
  }

  function addMove(move, rowid = 0) {
    if (!playbookMoves[move]) {
      console.log('Invalid/Unknown Move Name');
      return;
    }
  }

  // Set the checkbox gear list item.
  function addGear(book, rowid = 0) {
    const playbook = bookName[book]
    if (playbook && playbookGear[playbook]) {

    }
  }



  // ---- Gear ----- //
  
  function addGearList(gear, rowid) {
    const newRowId = rowid || generateRowID();

    const tags = gear.tags && gear.tags.length ? ` - (${gear.tags.join(' / ')})` : '';
 
    setAttrs({
      [`repeating_gearlist_${newRowId}_name`]: gear.name || '',
      [`repeating_gearlist_${newRowId}_quantity`]: gear.quantity || '',
      [`repeating_gearlist_${newRowId}_tier`]: gear.tier || '',
      [`repeating_gearlist_${newRowId}_tags`]: tags,
    });
  }

  function addGear(gear, rowid) {
    const newRowId = rowid || generateRowID();
    const tags = gear.tags && gear.tags.length ? ` - (${gear.tags.join(' / ')})` : '';

    setAttrs({
      [`repeating_gearcheck_${newRowId}_gear_name`]: gear.name || '',
      [`repeating_gearcheck_${newRowId}_gear_tier`]: gear.tier || '',
      [`repeating_gearcheck_${newRowId}_gear_tags`]: tags,
    })

  }

  function setGear(book) {
    clearGearList();

    if (!playbookGear[book]) {
      return;
    }

    const gearList = playbookGear[book].startingGear;
    const gear = playbookGear[book].classGear;

    for (let i = 0; i < gearList.length; i++) {
      addGearList(gearList[i]);
    }

    for (let i = 0; i < gear.length; i++) {
      addGear(gear[i]);
    }
  }
  

  // ----- Tear Down ----- //

  function clearGearList() {
    getSectionIDs('repeating_gearlist', (idArray) => {
      _.forEach(idArray, (id) => {
        removeRepeatingRow(`repeating_gearlist_${id}`);
      });
    })

    getSectionIDs('repeating_gearcheck', (idArray) => {
      _.forEach(idArray, (id) => removeRepeatingRow(`repeating_gearcheck_${id}`));
    })
  }

  function clearBasicMoveList() {
    getSectionIDs('repeating_basicmoves', (idArray) => {
      _.forEach(idArray, (id) => {
        removeRepeatingRow(`repeating_basicmoves_${id}`);
      });
    })
  }

  function clearMoveList() {
    getSectionIDs('repeating_moves', (idArray) => {
      _.forEach(idArray, (id) => {
        removeRepeatingRow(`repeating_moves_${id}`);
      });
    })
  }

  function setRollValue(prefix) {
    
    if (!prefix) {
      return;
    }
    
    getAttrs([
      `repeating_moves_${prefix}_move_name`,
    ], (values) => {

    });
  }

  function buildSingleRollValue(roll, prefix) {
    return '&{template:move} '
          +'{{charname=@{character_name}}}'
          +'{{movename=@{' + prefix + 'name}}} '
          +'{{trait='+ roll +'}}'
          +'{{result=[[ 2d6 + @{' + roll.toLowerCase() + '}]]}} '
          +'{{success=@{' + prefix + 'success}}} '
          +'{{partial=@{'+ prefix + 'partial}}} '
          +'{{miss=@{'+ prefix + 'miss}}} '
          +'{{doroll=@{' + prefix + 'doroll}}} '
          +'{{details=@{' + prefix + 'details}}}';
  }

  // takes array of strings, eg: ['KNOW', 'DEFY']
  function buildRollValue(rolls, prefix) {
    let rollValue = '?{Choose a Trait|';

    _.forEach(rolls, (roll, index) => {
      const last = index === rolls.length - 1;
      const lastChar = last ? '}' : '|';
      
      rollValue += '+' + roll 
      +',&{template:move&#125 '
      +'{{details=@{' + prefix + 'details}&#125&#125'
      +'{{charname=@{character_name}&#125&#125 '
      +'{{doroll=@{' + prefix + 'doroll}&#125&#125 '
      +'{{miss=@{'+ prefix + 'miss}&#125&#125 '
      +'{{movename=@{' + prefix + 'name}&#125&#125 '
      +'{{partial=@{'+ prefix + 'partial}&#125&#125 '
      +'{{result=[[ 2d6 + @{' + roll.toLowerCase() + '}]]&#125&#125 '
      +'{{success=@{' + prefix + 'success}&#125&#125 '
      +'{{trait='+ roll +'&#125&#125'
      + lastChar;

    });

    return rollValue;
  }

  function buildRollTemplateValue(roll, prefix) {
    return 
  }


</script>

<!-- 
  TODO:
    - Radio buttons for dangers section.
    - Moves keep bugging out, fix it.
    - Figure out equipment name with tags formatting/interpolation.

  ?{Choose a Trait|+DEFY, &{template:move} 
  {{charactername=@{character_name}}} 
  {{movename=@{repeating_basicmoves_-M0uLOaiZLJXAJDpQFpT_move_name}}} 
  {{trait=DEFY}}{{result=[[ 2d6 + @{defy}]]}} 
  {{success=@{repeating_basicmoves_-M0uLOaiZLJXAJDpQFpT_move_success}}} 
  {{partial=@{repeating_basicmoves_-M0uLOaiZLJXAJDpQFpT_move_partial}}} 
  {{miss=@{repeating_basicmoves_-M0uLOaiZLJXAJDpQFpT_move_miss}}} 
  {{doroll=@{repeating_basicmoves_-M0uLOaiZLJXAJDpQFpT_move_doroll}}} 
  {{details=@{repeating_basicmoves_-M0uLOaiZLJXAJDpQFpT_move_details}}}
  |
  +KNOW, &{template:move}
  {{charactername=@{character_name}}}
  {{movename=@{repeating_basicmoves_-M0uLOaiZLJXAJDpQFpT_move_name}}}
  {{trait=KNOW}}
  {{result=[[ 2d6 + @{know}]]}}
  {{success=@{repeating_basicmoves_-M0uLOaiZLJXAJDpQFpT_move_success}}}
  {{partial=@{repeating_basicmoves_-M0uLOaiZLJXAJDpQFpT_move_partial}}}
  {{miss=@{repeating_basicmoves_-M0uLOaiZLJXAJDpQFpT_move_miss}}}
  {{doroll=@{repeating_basicmoves_-M0uLOaiZLJXAJDpQFpT_move_doroll}}}
  {{details=@{repeating_basicmoves_-M0uLOaiZLJXAJDpQFpT_move_details}}}}

-->